<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>web storage</title> 
    <script src="js/jquery-3.6.0.js"></script>
    <script>
    if(localStorage || sessionStorage){
        console.log("웹스토리지를 사용할 수 있습니다.");

    }
    else {
        console.log("웹스토리지를 사용이 불가능한 브라우저입니다.");
    }
    </script>
</head>
<body onload="displayGuestbook();">
    <h1>web storage</h1>
    <fieldset>
        <legend>Local Storage</legend>
        <input type="text" id="key" placeholder="key">
        <input type="text" id="value" placeholder="value">
        <hr>
        <button id="btn1">저장</button>
        <button id="btn2">조회</button>
        <button id="btn3">삭제</button>
        <button id="btn4" onclick="localStorage.clear();">전체삭제</button>
    </fieldset>
    <script>
    const $key = $(key);
    const $value = $(value);

    /**
     * 삭제
     */
    $(btn3).click(() => {
        localStorage.removeItem($key.val());
    });

    /**
    * 조회
    * - key를 통해 value를 조회
    * - key 존재하지 않는 경우 null을 리턴
    */
    $(btn2).click(() => {
        const v = localStorage.getItem($key.val());
        console.log(v);

        if(v)
            $value.val(v);
        else   
            alert("해당 요소는 존재하지 않습니다.");
            $key.val('');
            $value.val('');
    });

    /**
     * 저장
     */
    $(btn1).click(() => {
        if($key.val() == '' || $value.val() == '')
            return;

            // localStorage객체 저장
            // 1. setter 메소드
            // localStorage.setItem($key.val(), $value.val());

            // 2. bracket notation
            localStorage[$key.val()] = $value.val();

            // 초기화
            $key.val('');
            $value.val('');
    });
    
    </script>

    <h2>객체저장</h2>
    <button id="btn5">객체저장</button>
    <script>
    /**
     * json
     * - javascript object notation 자바스크립 객체 표기법
     * - 데이터교환 포맷언어. 이종간의 데이터통신에 주로 사용
     * - javascript, java, c/c++, python.....
     */
    $(btn5).click(() => {
        const arr = [1,2,3,4,5];
        localStorage.setItem("arr", JSON.stringify(arr)); 

        const obj = {
            width: 30,
            height: 50,
            color: ['red', 'green', 'blue', 'pink'],
            user: {
                id: "honggd",
                age: 30,
                job: ['개발자', '농부', '강태공']
            }
        };
        localStorage.setItem("obj", JSON.stringify(obj));

        const _arr = localStorage.getItem("arr");
        const _obj = localStorage.getItem("obj");
        // JSON으로 저장하면 스트링으로 저장되어 있음
        console.log(_arr, typeof _arr);
        console.log(_obj, typeof _obj);
        // 다시 객체나 배열로 만들어 주기 위해 JSON 사용
        console.log(JSON.parse(_arr));
        console.log(JSON.parse(_obj));
    });
    </script>
    
    <h2>방명록</h2>
    <form action="javascript:saveGuestbook()" name="guestbookFrm">
        <fieldset>
            <table>
                <tr>
                    <th><label for="username">이름</label></th>
                    <td>
                        <input type="text" name="username" id="username">
                    </td>
                </tr>
                <!-- tr>th>label^td>input -->
                <tr>
                    <th><label for="content">내용</label></th>
                    <td><input type="text" name="content" id="content"></td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align:center;">
                        <button>저장</button>
                    </td>
                </tr>
            </table>
        </fieldset>
    </form>
    <table id="tb-guestbook">
        <thead>
            <tr>
                <th>순번</th>
                <th>이름</th>
                <th>내용</th>
                <th>작성일시</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <style>
    #tb-guestbook {
        border: 1px solid #000;
        border-collapse: collapse;
        margin-top: 10px;
    }
    #tb-guestbook th, #tb-guestbook td {
        border: 1px solid #000;
        padding: 5px;
    }
    </style>
    <script>
    /**
     * @실습문제:
     * (최신순)
     * 
     * 순번     이름    내용    작성일시
     * -----------------------------------
     * 1        홍길동  안녕    2021/10/19 17:50
     * 2        홍길순  어이    2021/10/19 16:50
     * 
     * 페이지 로딩시에 최초1회 자동 실행될 것.
     */
    const displayGuestbook = () => {
        const guestbooks = JSON.parse(localStorage.getItem("guestbooks"));
        guestbooks.reverse(); // 원본배열
        console.log(guestbooks);        

        const $tbody = $("#tb-guestbook tbody");
        $tboby.empty();
        $.each(guestbooks, (i, {username, content, datetime}) => {
            $tbody.append(`<tr>
  <td>${i + 1}</td>
  <td>${username}</td>
  <td>${content}</td>
  <td>${formatDatetime(datetime)}</td>
</tr>`);
        });
    };

    const formatDatetime = (millis) => {
        const d = new Date(millis);
        const f = (n) => n >= 10 ? n : "0" + n
        return `${d.getFullYear()}/${f.getMonth() + 1}/${f.getDate()} ${f.getHours()}:${f.getMinutes()}`;
    };

    const saveGuestbook = () => {
        const $username = $(username);
        const $content = $(content);

        if($username.val() == "" || $content.val() == "")
            return;

        // 1. 사용자입력값으로 Guestbook 객체생성
        const gb = new Guestbook($username.val(), $content.val());

        // 2. localStorage에 추가 : 배열로 관리
        const guestbooks = JSON.parse(localStorage.getItem("guestbooks")) || [];
        guestbooks.push(gb);

        console.log(guestbooks);

        localStorage.setItem("guestbooks", JSON.stringify(guestbooks));

        // 3. 초기화
        $username.val('');
        $content.val('');

        // 방명록 목록보기
        displayGuestbook();

    };

    class Guestbook {
        constructor(username, content){
            this.username = username;
            this.content = content;
            this.datetime = Date.now(); // unix time 밀리초
        }
    }
    </script>




    <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
</body>
</html>